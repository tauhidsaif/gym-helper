<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Body-Part Today â€” Yesterday + Calendar</title>
<meta name="theme-color" content="#ffffff" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Manrope:wght@600;700;800&display=swap" rel="stylesheet">
<style>
/* ---------- Variables & Base ---------- */
:root{
  --bg:#ffffff; --bg-2:#f6f7fb; --panel:#ffffff; --ink:#0f172a; --muted:#586273; --line:#e6eef8;
  --brand:#2563eb; --brand-2:#60a5fa; --radius:14px; --shadow:0 8px 22px rgba(15,23,42,.06);
  --accent:#e6f0ff;
  --icon-size:18px;
  --max-app-width:1100px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font:15.5px/1.45 "Inter", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  color:var(--ink);
  background:var(--bg-2);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  -webkit-tap-highlight-color: transparent;
  -webkit-font-smoothing:antialiased;
  -webkit-user-select: none;
  user-select: none;
  touch-action: manipulation;
}
a{color:inherit}
button,input{font:inherit}
.app{max-width:var(--max-app-width);margin-inline:auto;padding:12px;box-sizing:border-box}
/* ensure header & main align exactly */
.header{position:sticky;top:0;z-index:40;background:linear-gradient(#ffffff, #ffffffd9);backdrop-filter:saturate(1.05) blur(4px);border-bottom:1px solid var(--line)}
.header-inner{max-width:var(--max-app-width);margin:auto;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 12px}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand-2));display:grid;place-items:center;color:white;font-weight:800;letter-spacing:.4px;font-family:"Manrope"}
.brand h1{font-size:18px;margin:0}
.brand small{color:var(--muted);display:block}
.actions{display:flex;gap:8px;align-items:center}
.btn{border:1px solid var(--line);background:var(--panel);padding:8px 10px;border-radius:10px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-size:14px}
.btn.primary{background:var(--brand);color:#fff;border-color:transparent}
.btn.ghost{background:#f8fafc}
.btn.danger{background:#fff1f2;color:#991b1b;border-color:#fecdd3}
.btn:active{transform:translateY(1px)}
.btn:focus{outline:3px solid rgba(37,99,235,.12);outline-offset:2px}
.input{padding:10px;border-radius:10px;border:1px solid var(--line);background:#fff;min-width:0}
.small{font-size:13px}
.muted{color:var(--muted)}

/* make interactive elements tappable on phones */
button, .part, .badge { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }

/* ---------- Layout ---------- */
.layout{display:grid;gap:12px;margin-top:12px;padding-bottom:72px} /* bottom padding for fab on small screens */
@media(min-width:980px){ .layout{grid-template-columns:340px 1fr} }

/* Card */
.card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px}

/* Left parts */
.part-grid{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
.part{display:inline-flex;align-items:center;gap:10px;padding:10px 12px;border-radius:999px;border:1px solid transparent;cursor:pointer;user-select:none;min-height:44px;white-space:nowrap;overflow:hidden}
.part .dot{width:16px;height:16px;border-radius:4px;flex:0 0 auto}
.part.active{box-shadow:0 8px 20px rgba(37,99,235,.12);transform:translateY(-2px);border-color:rgba(37,99,235,.12)}
.add-row{display:flex;gap:8px;margin-top:12px;align-items:center}
.add-row .input{flex:1}
.badge{display:inline-flex;align-items:center;gap:10px;padding:8px 12px;border-radius:999px;background:#f0f7ff;border:1px solid #e2efff;font-size:13px;overflow:hidden}
.badge span{display:inline-block;vertical-align:middle}
.badge > span + span{min-width:0;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* Yesterday card (prominent on mobile) */
.yesterday-card{padding:14px;border-radius:12px;border:1px solid #eaf2ff;background:linear-gradient(180deg,#ffffff,#f7fbff);margin-bottom:12px}
.yesterday-empty{color:var(--muted);padding:8px}

/* Calendar */
.calendar{display:flex;flex-direction:column;gap:8px;padding:10px;border-radius:12px;border:1px solid var(--line);background:linear-gradient(#fff,#fbfdff)}
.cal-head{display:flex;align-items:center;justify-content:space-between;gap:8px}
.cal-month{font-weight:700}
.cal-controls{display:flex;gap:8px;align-items:center}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:6px}
.cal-cell{min-height:44px;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;border-radius:8px;padding:6px;cursor:pointer;transition:transform .08s ease, box-shadow .08s ease}
.cal-cell:active{transform:translateY(1px)}
.cal-cell.small{min-height:36px;padding:4px}
.cal-daynum{font-weight:700}
.cal-dot{width:6px;height:6px;border-radius:999px;margin-top:6px}
.cal-cell.disabled{opacity:.35;cursor:default}
.cal-cell.today{outline:2px solid rgba(37,99,235,.12)}
.cal-cell.selected{background:linear-gradient(90deg,var(--brand),var(--brand-2));color:white}
.cal-weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:6px}
.cal-weekdays div{font-size:12px;text-align:center;color:var(--muted)}

/* Today + Selected */
.today-card{display:flex;flex-direction:column;gap:8px;padding:12px;border-radius:12px;border:1px solid var(--line);background:linear-gradient(#fff,#fbfdff)}
.today-chips{display:flex;flex-wrap:wrap;gap:8px}
.today-empty{color:var(--muted);padding:10px}

/* History */
.divider{height:1px;background:var(--line);margin:12px 0;border-radius:4px}
.days-list{display:flex;flex-direction:column;gap:8px;max-height:420px;overflow:auto;padding-right:4px}
.day-row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;border-radius:10px;border:1px solid var(--line);background:#fff;min-height:56px}
.day-left{display:flex;gap:12px;align-items:center;flex:1;min-width:0}
.day-date{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.day-chips{display:flex;gap:6px;flex-wrap:wrap;overflow:hidden}

/* Edit panel in history */
.edit-panel{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;padding-top:8px;border-top:1px dashed var(--line)}

/* Fab */
.fab{position:fixed;right:16px;bottom:16px;background:var(--brand);color:#fff;border:none;border-radius:999px;padding:12px 14px;box-shadow:var(--shadow);display:inline-flex;align-items:center;gap:8px;z-index:70}
@media(min-width:900px){ .fab{display:none} }

/* Toast */
.toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%) translateY(10px);background:#0f172a;color:#fff;padding:10px 14px;border-radius:12px;opacity:0;pointer-events:none;transition:.25s;z-index:60;display:inline-flex;gap:8px;align-items:center;box-shadow:0 6px 18px rgba(15,23,42,.16)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.error{background:linear-gradient(90deg,#ef4444,#b91c1c);color:#fff}
.toast[aria-hidden="false"]{pointer-events:auto}

/* small icon in toast */
.toast::before{content:'';width:10px;height:10px;border-radius:2px;background:rgba(255,255,255,0.18);display:inline-block;margin-right:6px}
.toast.error::before{background:rgba(255,255,255,0.22)}

/* Responsive rules: ensure yesterday visible first on phone */
@media(max-width:979px){
  .layout{display:flex;flex-direction:column}
  /* Yesterday card first */
  .yesterday-card{ order:-2 }
  /* Quick Mark second */
  .layout > aside { order:-1 }
  /* other blocks after */
  .layout > section { order:0 }
  .yesterday-card, .layout > aside, .layout > section { width:100% }
  .header-inner{padding-left:10px;padding-right:10px}
  .app{padding-left:10px;padding-right:10px}
}

/* On narrow phones prefer two columns for parts (more readable),
   but we clamp so chips don't fill full width and push yesterday away */
@media(max-width:520px){
  .part{flex:0 0 calc(50% - 8px); padding:8px 8px; font-size:14px}
  .part .dot{width:10px;height:10px;border-radius:3px}
  .cal-head{flex-direction:column;align-items:flex-start;gap:6px}
  .cal-grid{gap:4px}
  .cal-cell{min-height:44px}
  .days-list{max-height:300px}
}

/* fallback for very narrow devices */
@media(max-width:420px){
  .part{flex:0 0 calc(50% - 6px); padding:7px 8px; font-size:13.5px}
  .part .dot{width:9px;height:9px}
  .badge > span + span{max-width:110px}
  .cal-weekdays div{font-size:11px}
  .cal-daynum{font-size:13px}
}

/* for really small (older) phones show 3 columns to avoid very tall list */
@media(max-width:360px){
  .part{flex:0 0 calc(33.333% - 8px); padding:6px 6px; font-size:13px; gap:6px}
  .badge > span + span{max-width:90px}
}

/* Modal styles (custom, replaces alert/confirm/prompt) */
.modal-overlay{position:fixed;inset:0;background:rgba(7,12,20,0.45);display:none;align-items:center;justify-content:center;z-index:80;padding:18px}
.modal{background:#fff;border-radius:12px;padding:18px;max-width:720px;width:100%;box-shadow:0 18px 50px rgba(8,15,40,.35);border:1px solid var(--line);max-height:86vh;overflow:auto}
.modal .modal-title{font-weight:700;margin-bottom:8px}
.modal .modal-body{margin-bottom:12px;color:var(--muted)}
.modal .modal-actions{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
.modal .modal-content-scroll{max-height:60vh;overflow:auto;padding:6px 0}
.parts-checkbox{display:flex;flex-wrap:wrap;gap:8px}
.parts-checkbox label{display:inline-flex;align-items:center;gap:8px;padding:8px;border-radius:8px;border:1px solid var(--line);background:#fbfdff;cursor:pointer}
.parts-checkbox input{margin-right:6px}
.modal-show{display:flex}

/* subtle focus row highlight for scrollToHistoryRow */
.focus-row{box-shadow:0 6px 22px rgba(96,165,250,.14);border-color:rgba(96,165,250,.2)}

/* helpful utilities */
.hidden{display:none!important}
.ellipsis{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
</style>
</head>
<body>
<!-- SVG icons -->
<svg xmlns="http://www.w3.org/2000/svg" style="display:none">
  <symbol id="i-download" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><path d="M7 10l5 5 5-5"/><path d="M12 15V3"/></symbol>
  <symbol id="i-upload" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><path d="M7 10l5-5 5 5"/><path d="M12 5v12"/></symbol>
  <symbol id="i-trash" viewBox="0 0 24 24"><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></symbol>
  <symbol id="i-plus" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></symbol>
  <symbol id="i-search" viewBox="0 0 24 24"><path d="M21 21l-4.35-4.35"/><circle cx="11" cy="11" r="6"/></symbol>
  <symbol id="i-edit" viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></symbol>
  <symbol id="i-calendar" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/></symbol>
  <symbol id="i-chevron-left" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></symbol>
  <symbol id="i-chevron-right" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></symbol>
</svg>

<div class="header">
  <div class="header-inner app" style="width:100%">
    <div class="brand">
      <div class="logo">GYM</div>
      <div>
        <h1>Body-Part Today</h1>
      </div>
    </div>
    <div class="actions" role="toolbar" aria-label="Top actions">
      <button id="btnReset" class="btn danger" title="Reset all" aria-label="Reset all">Reset</button>
    </div>
  </div>
</div>

<main class="app" aria-live="polite">
  <section class="layout">
    
    <!-- YESTERDAY card FIRST -->
    <div class="yesterday-card card" id="yesterdayCard" aria-hidden="false">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <div class="small muted">What you did yesterday</div>
          <div id="yesterdayDate" style="font-weight:800;margin-top:6px"></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="copyYesterday" class="btn primary" title="Copy yesterday's parts to today" aria-label="Copy yesterday to today">Copy yesterday â†’ today</button>
          <button id="viewYesterday" class="btn ghost" title="Open yesterday in history" aria-label="Open yesterday">Open</button>
        </div>
      </div>
      <div style="margin-top:12px" id="yesterdayChipsWrap">
        <div id="yesterdayChips" style="display:flex;flex-wrap:wrap;gap:8px"></div>
        <div id="yesterdayEmpty" class="yesterday-empty" style="display:none">No parts recorded yesterday.</div>
      </div>
    </div>

    <!-- QUICK MARK second -->
    <aside class="card" aria-label="Body part controls">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <div>
          <h2 style="margin:0">Quick Mark</h2>
          <div class="small muted">Tap a body part to toggle it for <strong>today</strong>.</div>
        </div>
        <div style="font-size:12px;color:var(--muted)">(tap to toggle)</div>
      </div>

      <div id="parts" class="part-grid" aria-live="polite"></div>

      <div class="add-row">
        <input id="newName" class="input" placeholder="Custom (e.g., Glutes)" aria-label="New part name" />
        <input id="newColor" class="input" type="color" value="#2563eb" style="width:56px;padding:6px" aria-label="New part color" />
        <button id="addPart" class="btn primary" aria-label="Add part"><svg style="width:16px;height:16px" aria-hidden="true"><use href="#i-plus"></use></svg>Add</button>
      </div>

      <div class="divider"></div>
      <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap">
        <div>
          <div class="small muted">This week sessions</div>
          <div id="wkDone" style="font-weight:800;font-size:20px">0</div>
        </div>
        <div>
          <div class="small muted">Streak (days)</div>
          <div id="streak" style="font-weight:800;font-size:20px">0</div>
        </div>
      </div>

      <div class="divider"></div>
      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
        <button id="clearToday" class="btn" aria-label="Clear today">Clear Today</button>
        <button id="todayBtn" class="btn ghost" aria-label="Go to today">Go to Today</button>
      </div>
    </aside>

    <!-- REST (Calendar, Today, History) third -->
    <section style="display:flex;flex-direction:column;gap:12px">
      <!-- Calendar -->
      <div class="calendar card" role="application" aria-label="Calendar navigator">
        <div class="cal-head">
          <div>
            <div class="cal-month" id="calMonthLabel"></div>
            <div class="small muted" id="calSubLabel">Tap a date to view or edit</div>
          </div>
          <div class="cal-controls" role="group" aria-label="Calendar controls">
            <button id="prevMonth" class="btn" aria-label="Previous month"><svg style="width:16px;height:16px" aria-hidden="true"><use href="#i-chevron-left"></use></svg></button>
            <button id="nextMonth" class="btn" aria-label="Next month"><svg style="width:16px;height:16px" aria-hidden="true"><use href="#i-chevron-right"></use></svg></button>
          </div>
        </div>
        <div class="cal-weekdays" aria-hidden="true">
          <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
        </div>
        <div id="calGrid" class="cal-grid" role="grid" aria-label="Month dates"></div>
      </div>

      <!-- Selected Date Details (Today by default) -->
      <div class="today-card card" id="selectedCard">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
          <div style="display:flex;flex-direction:column">
            <div class="small muted" id="selectedLabel">Selected</div>
            <div id="selectedDate" style="font-weight:800"></div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="copyToToday" class="btn" title="Copy these parts to today">Copy â†’ today</button>
            <button id="editSelected" class="btn">Edit</button>
            <button id="delSelected" class="btn" title="Delete selected date" aria-label="Delete selected date"><svg style="width:16px;height:16px" aria-hidden="true"><use href="#i-trash"></use></svg></button>
          </div>
        </div>

        <div style="margin-top:10px">
          <div class="today-chips" id="selectedChips" aria-live="polite"></div>
          <div id="selectedEmpty" class="today-empty" style="display:none">No body parts recorded for this date.</div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- History -->
      <div class="card" style="padding:12px">
        <h3 style="margin:0 0 8px 0">History</h3>
        <div class="small muted">Recent days â€” click a row to open quick editor (or use calendar).</div>
        <div style="height:8px"></div>
        <div id="days" class="days-list" aria-live="polite"></div>
        <div id="noHistory" class="today-empty" style="display:none">No history yet. Mark a part to start logging.</div>
      </div>
    </section>

  </section>
</main>

<div id="toast" class="toast" role="status" aria-live="polite" aria-hidden="true"></div>

<!-- Custom modal overlay (used instead of alert/confirm/prompt) -->
<div id="modalOverlay" class="modal-overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div id="modalTitle" class="modal-title"></div>
    <div id="modalBody" class="modal-body"></div>
    <div id="modalContent" class="modal-content-scroll"></div>
    <div class="modal-actions" id="modalActions"></div>
  </div>
</div>

<script>
(() => {
  // ===== Helpers & Date utils =====
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const uid = () => Math.random().toString(36).slice(2,10);
  const iso = d => new Date(d).toISOString().slice(0,10); // yyyy-mm-dd
  const todayDate = () => iso(new Date());
  const startOfWeek = (date) => { const d = new Date(date); const day = (d.getDay() + 6) % 7; d.setHours(0,0,0,0); d.setDate(d.getDate()-day); return d; };
  const addDays = (d,n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x; };

  // Display date as DD-MM-YYYY
  function ddmmyyyy(isoDate){
    if(!isoDate) return '';
    const [y,m,d] = isoDate.split('-');
    return `${d.padStart(2,'0')}-${m.padStart(2,'0')}-${y}`;
  }
  // weekday + dd-mm-yyyy
  function displayDate(isoDate){
    if(!isoDate) return '';
    const dt = new Date(isoDate+'T00:00:00');
    const weekday = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dt.getDay()];
    return `${weekday} ${ddmmyyyy(isoDate)}`;
  }

  // prettier toast: accepts type 'error' or omitted
  const toast = (t, type = '') => {
    const el = $('#toast');
    if(!el) return;
    el.textContent = t;
    el.setAttribute('aria-hidden','false');
    el.classList.remove('error', 'show');
    if(type === 'error') el.classList.add('error');
    // show
    el.classList.add('show');
    clearTimeout(el._t);
    el._t = setTimeout(()=> {
      el.classList.remove('show');
      el.classList.remove('error');
      el.setAttribute('aria-hidden','true');
    }, type === 'error' ? 2600 : 1400);
  };

  // ===== Modal utility (replaces alert/confirm/prompt) =====
  const modalOverlay = $('#modalOverlay');
  const modalTitle = $('#modalTitle');
  const modalBody = $('#modalBody');
  const modalContent = $('#modalContent');
  const modalActions = $('#modalActions');

  function closeModal(){
    modalOverlay.classList.remove('modal-show');
    modalOverlay.setAttribute('aria-hidden','true');
    modalTitle.textContent = '';
    modalBody.textContent = '';
    modalContent.innerHTML = '';
    modalActions.innerHTML = '';
  }

  function showModal({ title = '', body = '', contentEl = null, actions = [] } = {}) {
    return new Promise(resolve => {
      modalTitle.textContent = title;
      modalBody.textContent = body || '';
      modalContent.innerHTML = '';
      if(contentEl) modalContent.appendChild(contentEl);
      modalActions.innerHTML = '';

      // actions: array of { label, value, className, onClick }
      actions.forEach(a => {
        const btn = document.createElement('button');
        btn.className = 'btn';
        if(a.className) btn.classList.add(...a.className.split(' '));
        btn.textContent = a.label;
        btn.addEventListener('click', async () => {
          try{
            const res = a.onClick ? await a.onClick() : a.value;
            closeModal();
            resolve(res === undefined ? a.value : res);
          }catch(err){
            toast(err?.message || 'Error', 'error');
          }
        });
        modalActions.appendChild(btn);
      });

      modalOverlay.classList.add('modal-show');
      modalOverlay.setAttribute('aria-hidden','false');
    });
  }

  // Confirm
  function showConfirm(message, opts = { title: 'Confirm', confirmText: 'Yes', cancelText: 'Cancel' }){
    return showModal({
      title: opts.title,
      body: message,
      actions: [
        { label: opts.cancelText, value: false, className: '' },
        { label: opts.confirmText, value: true, className: 'primary' }
      ]
    });
  }

  // Parts editor: choose parts via checkboxes (returns array of selected ids or null if canceled)
  function showPartsEditorForDate(date){
    const wrapper = document.createElement('div');
    wrapper.style.minWidth = '260px';
    const note = document.createElement('div');
    note.style.marginBottom = '8px';
    note.style.color = 'var(--muted)';
    note.textContent = 'Choose parts for ' + ddmmyyyy(date);
    wrapper.appendChild(note);

    const box = document.createElement('div');
    box.className = 'parts-checkbox';
    wrapper.appendChild(box);

    const current = new Set(H[date] || []);
    for(const p of G.parts){
      const id = p.id;
      const lbl = document.createElement('label');
      const chk = document.createElement('input');
      chk.type = 'checkbox';
      chk.value = id;
      chk.checked = current.has(id);
      const dot = document.createElement('span');
      dot.style.width = '10px'; dot.style.height='10px'; dot.style.background = p.color; dot.style.display='inline-block'; dot.style.borderRadius='3px';
      const nameSpan = document.createElement('span');
      nameSpan.textContent = p.name;
      lbl.appendChild(chk);
      lbl.appendChild(dot);
      lbl.appendChild(nameSpan);
      box.appendChild(lbl);
    }

    return showModal({
      title: 'Edit parts',
      body: '',
      contentEl: wrapper,
      actions: [
        { label: 'Cancel', value: null },
        { label: 'Save', className: 'primary', onClick: () => {
            const checked = Array.from(box.querySelectorAll('input[type=checkbox]:checked')).map(i => i.value);
            return checked;
        }}
      ]
    });
  }

  // ===== Storage keys & defaults =====
  const keyG = 'bp:global:v1'; // parts + meta
  const keyH = 'bp:history:v1'; // history map

  const defaults = [
    {id: 'p_chest', name:'Chest', color:'#2563eb'},
    {id: 'p_back', name:'Back', color:'#16a34a'},
    {id: 'p_legs', name:'Legs', color:'#f59e0b'},
    {id: 'p_shoulders', name:'Shoulders', color:'#8b5cf6'},
    {id: 'p_arms', name:'Arms', color:'#14b8a6'},
    {id: 'p_core', name:'Core', color:'#ef4444'},
    {id: 'p_cardio', name:'Cardio', color:'#60a5fa'},
  ];

  // ===== State =====
  let G = { parts: [], lastUsed: null, streak: 0 };
  let H = {}; // history: { 'yyyy-mm-dd': [ partId, ... ] }

  // Calendar state
  let calDate = new Date(); // month view
  let selectedDate = todayDate(); // iso string selected by calendar or history

  // ===== Load/Save =====
  function loadAll(){
    try{ const x = JSON.parse(localStorage.getItem(keyG)); if(x) G = x }catch(e){}
    try{ const y = JSON.parse(localStorage.getItem(keyH)); if(y) H = y }catch(e){}
    if(!G.parts || !G.parts.length){ G.parts = defaults.map(p=>({ ...p })); saveG(); }
  }
  function saveG(){ try{ localStorage.setItem(keyG, JSON.stringify(G)); }catch(e){ console.warn('saveG failed', e); } }

  // single saveH centralised
  function saveH(){
    try{ localStorage.setItem(keyH, JSON.stringify(H)); }catch(e){ console.warn('saveH failed', e); }
    compute();
    renderHistory();
    renderCalendar();
    renderSelected();
    renderYesterday();
    renderTodayActive();
  }

  function resetAll(){ localStorage.removeItem(keyG); localStorage.removeItem(keyH); G={parts:[],lastUsed:null,streak:0}; H={}; loadAll(); compute(); renderAll(); toast('Reset complete'); }

  // ===== Utilities =====
  function findPart(id){ return G.parts.find(p=>p.id===id); }
  function addPart(name,color){ const p = { id: uid(), name: name.trim(), color }; G.parts.push(p); saveG(); renderParts(); toast('Added part'); return p; }
  function escape(s){ return (s||'').toString().replace(/[&<>\"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // ===== Core operations =====
  function toggleDatePart(date, partId){
    const arr = H[date] ? (H[date].slice()) : [];
    const idx = arr.indexOf(partId);
    if(idx === -1){
      arr.push(partId);
      H[date] = arr;
      G.lastUsed = date;
      toast('Marked '+ (findPart(partId)?.name || 'part') + ' for ' + ddmmyyyy(date));
    } else {
      arr.splice(idx,1);
      if(arr.length===0) delete H[date]; else H[date] = arr;
      toast('Unmarked '+ (findPart(partId)?.name || 'part') + ' for ' + ddmmyyyy(date));
    }
    saveH(); saveG(); compute();
  }

  function clearDate(date){
    if(H[date]){ delete H[date]; saveH(); toast('Cleared '+ddmmyyyy(date)); }
  }
  function deleteDate(date){
    if(H[date]){ delete H[date]; saveH(); toast('Deleted '+ddmmyyyy(date)); }
  }

  // Copy functions
  function copyYesterdayToToday(){
    const y = iso(addDays(new Date(), -1));
    const yArr = (H[y] || []).slice();
    if(yArr.length===0) return toast('No data yesterday to copy', 'error');
    const t = todayDate();
    const tSet = new Set(H[t] || []);
    yArr.forEach(id => tSet.add(id));
    H[t] = Array.from(tSet);
    G.lastUsed = t;
    saveH(); compute(); toast('Copied yesterday to today');
  }
  function copySelectedToToday(){
    if(!selectedDate) return;
    const src = H[selectedDate] || [];
    if(src.length===0) return toast('Selected date has no parts', 'error');
    const t = todayDate();
    const tSet = new Set(H[t] || []);
    src.forEach(id => tSet.add(id));
    H[t] = Array.from(tSet);
    G.lastUsed = t;
    saveH(); compute(); toast('Copied selected date to today');
  }

  // ===== Rendering: Parts (left) =====
  function renderParts(){
    const host = $('#parts'); if(!host) return;
    host.innerHTML = '';
    const today = H[todayDate()] || [];
    // create document fragment for performance
    const frag = document.createDocumentFragment();
    for(const p of G.parts){
      const el = document.createElement('button');
      el.className = 'part';
      if(today.includes(p.id)) el.classList.add('active');
      el.setAttribute('aria-pressed', today.includes(p.id) ? 'true' : 'false');
      // name wrapped in a span and ellipsis class so text won't overflow
      el.innerHTML = `<span class="dot" style="background:${p.color}"></span><span style="font-weight:600;display:inline-block;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escape(p.name)}</span>`;
      el.addEventListener('click', ()=> toggleDatePart(todayDate(), p.id));
      el.addEventListener('keydown', (ev) => { if(ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); toggleDatePart(todayDate(), p.id); }});
      frag.appendChild(el);
    }
    host.appendChild(frag);
  }

  // Render active state on left when non-today selected (keeps left toggles focused to today)
  function renderTodayActive(){
    // update left panel active classes based on today
    const todaySet = new Set(H[todayDate()] || []);
    $$('#parts .part').forEach((el, idx) => {
      const p = G.parts[idx];
      if(!p) return;
      if(todaySet.has(p.id)) el.classList.add('active'); else el.classList.remove('active');
      el.setAttribute('aria-pressed', todaySet.has(p.id) ? 'true' : 'false');
    });
  }

  // ===== Rendering: Yesterday (prominent) =====
  function renderYesterday(){
    const yKey = iso(addDays(new Date(), -1));
    const yDateEl = $('#yesterdayDate'); if(yDateEl) yDateEl.textContent = displayDate(yKey);
    const arr = H[yKey] || [];
    const chipsHost = $('#yesterdayChips'); if(!chipsHost) return;
    chipsHost.innerHTML = '';
    if(arr.length===0){
      $('#yesterdayEmpty').style.display = 'block';
      chipsHost.style.display = 'none';
    } else {
      $('#yesterdayEmpty').style.display = 'none';
      chipsHost.style.display = 'flex';
      for(const id of arr){
        const p = findPart(id) || { name: id, color: '#ddd' };
        const chip = document.createElement('div'); chip.className='badge';
        chip.innerHTML = `<span style="width:12px;height:12px;background:${p.color};border-radius:3px;display:inline-block"></span><span style="font-weight:600;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-left:6px">${escape(p.name)}</span>`;
        chipsHost.appendChild(chip);
      }
    }
  }

  // ===== Calendar Rendering & Interaction =====
  function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
  function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }

  function renderCalendar(){
    const grid = $('#calGrid'); if(!grid) return;
    grid.innerHTML = '';
    const monthStart = startOfMonth(calDate);
    const monthEnd = endOfMonth(calDate);
    const monthLabel = monthStart.toLocaleString(undefined, { month: 'long', year:'numeric' });
    $('#calMonthLabel').textContent = monthLabel;
    $('#calSubLabel').textContent = 'Tap a date to view or edit';

    // Determine starting blank cells (week day of first)
    const startDow = monthStart.getDay(); // 0=Sun
    const daysInMonth = monthEnd.getDate();

    // Build leading blanks (prev month)
    const prevMonthEnd = new Date(calDate.getFullYear(), calDate.getMonth(), 0);
    const prevDays = prevMonthEnd.getDate();
    for(let i=0;i<startDow;i++){
      const day = prevDays - (startDow - 1 - i);
      const isoKey = iso(new Date(calDate.getFullYear(), calDate.getMonth()-1, day));
      const cell = makeCalCell(day, isoKey, true);
      grid.appendChild(cell);
    }
    // Current month days
    for(let d=1; d<=daysInMonth; d++){
      const isoKey = iso(new Date(calDate.getFullYear(), calDate.getMonth(), d));
      const cell = makeCalCell(d, isoKey, false);
      grid.appendChild(cell);
    }
    // Trailing blanks to fill the grid to a multiple of 7
    const totalCells = startDow + daysInMonth;
    const trailing = (7 - (totalCells % 7)) % 7;
    for(let i=1;i<=trailing;i++){
      const isoKey = iso(new Date(calDate.getFullYear(), calDate.getMonth()+1, i));
      const cell = makeCalCell(i, isoKey, true);
      grid.appendChild(cell);
    }
  }

  function makeCalCell(dayNum, isoKey, dim){
    const cell = document.createElement('div');
    cell.className = 'cal-cell' + (dim ? ' disabled small' : '');
    const dayDiv = document.createElement('div'); dayDiv.className='cal-daynum'; dayDiv.textContent = dayNum;
    cell.appendChild(dayDiv);
    // show dot if that date has data
    if(H[isoKey] && H[isoKey].length>0){
      const dot = document.createElement('div'); dot.className='cal-dot';
      dot.style.background = 'linear-gradient(90deg,var(--brand),var(--brand-2))';
      cell.appendChild(dot);
    } else {
      const spacer = document.createElement('div'); spacer.style.height='6px'; cell.appendChild(spacer);
    }
    const todayIso = todayDate();
    if(isoKey === todayIso) cell.classList.add('today');
    if(isoKey === selectedDate) cell.classList.add('selected');
    // click handler: if dim (not current month) still allow selecting that date (navigate months)
    cell.addEventListener('click', ()=> {
      // prevent clicks on pure disabled reference cells from doing heavy actions if they are far (but allow navigation)
      selectedDate = isoKey;
      const clicked = new Date(isoKey + 'T00:00:00');
      if(clicked.getMonth() !== calDate.getMonth()){
        calDate = clicked;
      }
      renderCalendar();
      renderSelected();
      // scroll selected into view (history)
      scrollToHistoryRow(isoKey);
    });
    return cell;
  }

  // Prev / Next month
  $('#prevMonth')?.addEventListener('click', ()=> { calDate = new Date(calDate.getFullYear(), calDate.getMonth()-1, 1); renderCalendar(); });
  $('#nextMonth')?.addEventListener('click', ()=> { calDate = new Date(calDate.getFullYear(), calDate.getMonth()+1, 1); renderCalendar(); });

  // ===== Selected Date (calendar-driven) =====
  function renderSelected(){
    const labelEl = $('#selectedLabel');
    const dateEl = $('#selectedDate');
    const chips = $('#selectedChips');
    const empty = $('#selectedEmpty');

    if(!selectedDate) selectedDate = todayDate();
    labelEl.textContent = (selectedDate === todayDate()) ? 'Today' : (selectedDate === iso(addDays(new Date(), -1)) ? 'Yesterday' : 'Selected');
    dateEl.textContent = displayDate(selectedDate) + ' â€¢ ' + selectedDate;
    chips.innerHTML = '';
    const arr = H[selectedDate] || [];
    if(arr.length===0){ empty.style.display='block'; } else { empty.style.display='none'; }
    for(const id of arr){
      const p = findPart(id) || { name: id, color: '#ddd' };
      const badge = document.createElement('div'); badge.className='badge';
      badge.innerHTML = `<span style="width:12px;height:12px;background:${p.color};border-radius:3px;display:inline-block"></span><span style="font-weight:600;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-left:6px">${escape(p.name)}</span>`;
      chips.appendChild(badge);
    }
  }

  // Copy selected -> today
  $('#copyToToday')?.addEventListener('click', ()=> copySelectedToToday());

  // Edit selected: open the parts editor modal
  $('#editSelected')?.addEventListener('click', async ()=> {
    const date = selectedDate || todayDate();
    const res = await showPartsEditorForDate(date);
    if(res === null) { /* canceled */ return; }
    if(res.length === 0){ delete H[date]; } else { H[date] = res; }
    saveH(); compute(); renderHistory(); renderSelected(); renderCalendar(); renderYesterday(); renderTodayActive();
    toast('Saved');
  });

  // Delete selected (uses modal confirm)
  $('#delSelected')?.addEventListener('click', async ()=> {
    const date = selectedDate || todayDate();
    if(H[date]){
      const ok = await showConfirm('Delete record for ' + ddmmyyyy(date) + ' ?');
      if(ok) deleteDate(date);
    } else {
      toast('No record to delete', 'error');
    }
  });

  // ===== History rendering =====
  function renderHistory(limit = 60){
    const host = $('#days'); if(!host) return;
    host.innerHTML = '';
    const keys = Object.keys(H).sort((a,b)=>b.localeCompare(a)); // newest first
    if(keys.length===0){ $('#noHistory').style.display = 'block'; } else { $('#noHistory').style.display = 'none' }
    const c = Math.min(keys.length, limit);
    const frag = document.createDocumentFragment();
    for(let i=0;i<c;i++){
      const k = keys[i];
      const arr = H[k] || [];
      const row = document.createElement('div'); row.className='day-row';
      const left = document.createElement('div'); left.className='day-left';
      const ddate = document.createElement('div'); ddate.className='day-date ellipsis'; ddate.textContent = displayDate(k) + ' â€¢ ' + k;
      const chips = document.createElement('div'); chips.className='day-chips';
      for(const id of arr){
        const p = findPart(id) || { name: id, color: '#ddd' };
        const chip = document.createElement('div'); chip.className='badge';
        chip.innerHTML = `<span style="width:10px;height:10px;background:${p.color};border-radius:3px;display:inline-block"></span><span style="font-weight:600;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-left:6px">${escape(p.name)}</span>`;
        chips.appendChild(chip);
      }
      left.appendChild(ddate); left.appendChild(chips);

      const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px'; right.style.alignItems='center';
      const editBtn = document.createElement('button'); editBtn.className='btn'; editBtn.textContent='Edit';
      const delBtn = document.createElement('button'); delBtn.className='btn'; delBtn.title='Delete'; delBtn.innerHTML = `<svg style="width:14px;height:14px" aria-hidden="true"><use href="#i-trash"></use></svg>`;

      editBtn.addEventListener('click', ()=> {
        // open an inline editor panel below the row
        toggleEditPanel(k, row);
      });

      delBtn.addEventListener('click', async ()=> {
        const ok = await showConfirm('Delete record for '+ddmmyyyy(k)+' ?');
        if(ok) deleteDate(k);
      });

      right.appendChild(editBtn); right.appendChild(delBtn);
      row.appendChild(left); row.appendChild(right);
      frag.appendChild(row);
    }
    host.appendChild(frag);
  }

  function toggleEditPanel(date, rowEl){
    const existing = rowEl.querySelector('.edit-panel');
    if(existing){ existing.remove(); return; }
    const panel = document.createElement('div'); panel.className='edit-panel';
    const arr = H[date] || [];
    for(const p of G.parts){
      const on = arr.includes(p.id);
      const btn = document.createElement('button'); btn.className='part';
      if(on) btn.classList.add('active');
      btn.style.padding='8px 10px';
      btn.innerHTML = `<span class="dot" style="background:${p.color}"></span><span style="font-weight:600">${escape(p.name)}</span>`;
      btn.addEventListener('click', ()=> {
        const nowArr = H[date] || [];
        const has = nowArr.indexOf(p.id)!==-1;
        setDatePart(date, p.id, !has);
        panel.remove();
      });
      panel.appendChild(btn);
    }
    rowEl.appendChild(panel);
    // scroll panel into view on smaller screens
    setTimeout(()=> panel.scrollIntoView({behavior:'smooth', block:'nearest'}), 80);
  }

  // Set/unset a part for a given date
  function setDatePart(date, partId, on){
    const arr = H[date] ? (H[date].slice()) : [];
    const idx = arr.indexOf(partId);
    if(on && idx === -1){ arr.push(partId); H[date] = arr; }
    if(!on && idx !== -1){ arr.splice(idx,1); if(arr.length===0) delete H[date]; else H[date] = arr; }
    saveH(); compute(); renderHistory(); renderSelected(); renderCalendar(); renderYesterday(); renderTodayActive();
  }

  // Scroll helper
  function scrollToHistoryRow(isoKey){
    // look for row containing the date text
    const rows = $$('#days .day-row .day-date');
    for(const el of rows){
      if(el.textContent && el.textContent.includes(isoKey)){
        el.scrollIntoView({behavior:'smooth', block:'center'});
        el.parentElement.classList.add('focus-row');
        setTimeout(()=> el.parentElement.classList.remove('focus-row'), 1400);
        return;
      }
    }
  }

  // ===== Compute metrics =====
  function compute(){
    // streak: consecutive days up to today with a record
    const keys = Object.keys(H).sort();
    const today = new Date(todayDate());
    let streak = 0;
    let cur = new Date(today);
    while(true){
      const k = iso(cur);
      if(H[k] && H[k].length>0){ streak++; cur.setDate(cur.getDate()-1); } else break;
    }
    G.streak = streak;
    saveG();
    const stEl = $('#streak'); if(stEl) stEl.textContent = G.streak || 0;

    // this week sessions (count of body parts marked in current week)
    const s = startOfWeek(today);
    let weekCount = 0;
    for(let i=0;i<7;i++){
      const d = iso(addDays(s,i));
      if(H[d]) weekCount += H[d].length;
    }
    const wkEl = $('#wkDone'); if(wkEl) wkEl.textContent = weekCount;
  }

  // ===== Export / Import / Reset =====
  $('#btnExport')?.addEventListener('click', ()=> {
    const out = { G, H };
    try{
      const blob = new Blob([JSON.stringify(out, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'body-part-log.json'; a.click(); URL.revokeObjectURL(url);
    }catch(e){ toast('Export failed', 'error'); }
  });

  $('#fileImport')?.addEventListener('change', async e=> {
    const f = e.target.files[0]; if(!f) return;
    try{
      const txt = await f.text();
      const data = JSON.parse(txt);
      if(data.G) { G = data.G; saveG(); }
      if(data.H) { H = data.H; saveH(); }
      renderAll(); compute(); toast('Imported');
    }catch(err){ toast('Invalid file', 'error'); }
    e.target.value = '';
  });

  // Reset uses modal confirm
  $('#btnReset')?.addEventListener('click', async ()=> {
    const ok = await showConfirm('Clear all data?');
    if(ok) resetAll();
  });

  // ===== UI actions =====
  $('#addPart')?.addEventListener('click', ()=> {
    const name = $('#newName').value.trim();
    const color = $('#newColor').value || '#2563eb';
    if(!name){ toast('Enter name', 'error'); return; }
    addPart(name, color);
    $('#newName').value = '';
  });

  $('#clearToday')?.addEventListener('click', async ()=> {
    const ok = await showConfirm('Clear all marks for today?');
    if(ok) clearDate(todayDate());
  });

  $('#todayBtn')?.addEventListener('click', ()=> {
    selectedDate = todayDate();
    renderCalendar();
    renderSelected();
    // scroll to top of main selected card
    $('#selectedCard')?.scrollIntoView({behavior:'smooth'});
  });

  $('#copyYesterday')?.addEventListener('click', ()=> copyYesterdayToToday());
  $('#viewYesterday')?.addEventListener('click', ()=> {
    const yKey = iso(addDays(new Date(), -1));
    selectedDate = yKey;
    renderCalendar();
    renderSelected();
    scrollToHistoryRow(yKey);
  });

  $('#fab')?.addEventListener('click', ()=> {
    if(G.lastUsed && H[G.lastUsed] && H[G.lastUsed].length){
      const lastArr = H[G.lastUsed] || [];
      const id = lastArr[ lastArr.length - 1 ] || (G.parts[0] && G.parts[0].id);
      if(id) toggleDatePart(todayDate(), id);
    } else {
      if(G.parts[0]) toggleDatePart(todayDate(), G.parts[0].id);
    }
  });

  // optional: key search (not shown in UI)
  $('#btnSearch')?.addEventListener('click', ()=> {
    const v = $('#searchDate')?.value.trim();
    if(!v){ toast('Enter date as YYYY-MM-DD', 'error'); return; }
    if(!/^\d{4}-\d{2}-\d{2}$/.test(v)){ toast('Date format invalid. Use YYYY-MM-DD', 'error'); return; }
    selectedDate = v;
    calDate = new Date(v+'T00:00:00');
    renderCalendar();
    renderSelected();
    scrollToHistoryRow(v);
  });

  // ===== Initial render helpers =====
  function renderAll(){
    renderParts();
    renderYesterday();
    renderCalendar();
    renderSelected();
    renderHistory();
    renderTodayActive();
  }

  // For import usage where we set H directly
  function setHAndRefresh(newH){
    H = newH || {};
    saveH();
  }

  // ===== Initialization =====
  loadAll();
  // ensure selectedDate defaults to today
  selectedDate = todayDate();
  renderAll();
  compute();

  // Re-render on storage changes (multi-tab)
  window.addEventListener('storage', ()=>{ loadAll(); renderAll(); compute(); });

  // Keyboard accessibility: left/right arrows move calendar month
  window.addEventListener('keydown', (e) => {
    if(e.key === 'ArrowLeft'){ calDate = new Date(calDate.getFullYear(), calDate.getMonth()-1, 1); renderCalendar(); }
    if(e.key === 'ArrowRight'){ calDate = new Date(calDate.getFullYear(), calDate.getMonth()+1, 1); renderCalendar(); }
  });

  // Expose a couple helper functions for debugging (optional)
  window._bp = { getState: () => ({ G, H }), renderAll, saveH: () => saveH(), showConfirm, showPartsEditorForDate, setHAndRefresh };
})();
</script>
</body>
</html>
